<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tree Environmental Preference Selector</title>

  <style>
    html {
      overflow-y: scroll;
}
html {
  scroll-behavior: smooth;
}
#back-to-top {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 10px 15px;
  background-color: var(--accent-color);
  transition: background-color 0.8s ease;
  color: white;
  text-decoration: none;
  border-radius: 5px;
}

    body {
	  --accent-color: #558B2F; 
      --secondary-accent: #33691E;
      --container-bg: #FDEBD0;
      --body-bg: #9CCC65;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #9CCC65;
      margin: 0;
      padding: 2rem 1rem;
      display: flex;
      justify-content: center;
    }

    .container {
      background-color: #FDEBD0;
      max-width: 900px;
      width: 100%;
      padding: 2.5rem;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      line-height: 1.6;
    }

#projectTitleDisplay, h1 {
  color: var(--accent-color) !important;
  transition: color 0.8s ease;
  margin-top: 0; margin-bottom: 0.5rem;
}

    h2 { margin-top: 0; margin-bottom: 0.5rem; }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
      padding: 1.5rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fdfaf7;
    }

input[type="checkbox"]:checked {
  accent-color: #558B2F !important;
}

body.fall-active input[type="checkbox"]:checked {
  accent-color: #8C1C04 !important;
}

body.fall-active .view-btn { 
  border-color: #C25C30 !important; 
  outline-color: #C25C30 !important; 
}

body.fall-active .view-btn.active {
  border-color: #C25C30 !important;
}

body.winter-active input[type="checkbox"]:checked {
  accent-color: #2980B9 !important;
}

body.winter-active .view-btn { 
  border-color: #2C3E50 !important; 
  outline-color: #2C3E50 !important; 
}

body.winter-active .view-btn.active {
  border-color: #2C3E50 !important;
}

body.spring-active input[type="checkbox"]:checked {
  accent-color: #D43F97 !important;
}

body.spring-active .view-btn { 
  border-color: #7BC043 !important; 
  outline-color: #7BC043 !important; 
}

body.spring-active .view-btn.active {
  border-color: #7BC043 !important;
}

.help-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  background-color: #999;
  color: #fff;
  border-radius: 50%;
  font-size: 11px;
  font-weight: bold;
  cursor: help;
  margin-left: 6px;
  vertical-align: middle;
  position: relative;
}

.help-icon::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 150%;
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: #fff;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: normal;
  line-height: 1.4;
  width: 200px;
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 100;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  pointer-events: none;
  width: 295px;
  white-space: pre-line;
  text-align: left;
}

.help-icon::before {
  content: "";
  position: absolute;
  bottom: 120%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: #333;
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.2s;
}

.help-icon:hover::after, .help-icon:hover::before {
  visibility: visible;
  opacity: 1;
}

    .multiselect { position: relative; width: 100%; }
    .selectBox { position: relative; cursor: pointer; }
    .selectBox select, #carbonate {
      width: 100%;
      height: 40px; 
      padding: 8px 10px;
      padding-right: 35px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      color: #333;
      font-family: system-ui, -apple-system, sans-serif;
      font-size: 14px;
      font-weight: 600;
      appearance: none;   
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 12px top 50%;
      background-size: 10px auto;
    }

    #carbonate option {
      font-size: 13px;
      font-weight: normal;
    }

    .checkboxes label {
      font-size: 13px !important;
      font-weight: 400 !important;
      padding: 6px 10px;
    }

    .multiselect > label, .filter-item > label {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }

    .filter-item {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .overSelect { position: absolute; left: 0; right: 0; top: 0; bottom: 0; }
    
    .checkboxes {
      display: none;
      position: absolute;
      left: 0; right: 0; top: 100%;
      border: 1px solid #ccc;
      background-color: #fff;
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .checkboxes label {
      display: block;
      padding: 8px 10px;
      font-weight: 400;
      cursor: pointer;
      margin: 0;
    }
    .checkboxes label:hover { background-color: #f0f0f0; }
    .checkboxes input { margin-right: 10px; }

input[type="checkbox"] {
  accent-color: #558B2F;
}

    label { font-weight: 600; display: block; margin-bottom: 4px; }

    button {
      grid-column: 1 / -1;
      padding: 0.8rem;
      font-size: 1rem;
	  font-weight: bold;
      cursor: pointer;
      background-color: #558B2F;
      color: white;
      border: none;
      border-radius: 4px;
      margin-top: 10px;
    }

    button[onclick="clearAllFilters()"] {
      background-color: #666;
    }

    .tree {
      display: flex;
      justify-content: flex-start;
      align-items: start;
      gap: 2rem;
      padding: 1.5rem 0;
      border-bottom: 2px solid var(--secondary-accent, #BDBDBD) !important;
      transition: all 0.2s ease;
    }

#results:not(.grid-view) .tree {
  display: flex;
  flex-direction: row; 
  align-items: flex-start;
  justify-content: flex-start;
  gap: 30px;
  width: 100%;
}

#results:not(.grid-view) .tree > div:nth-child(3) {
  order: 1 !important; 
  width: 120px;
  flex: 0 0 120px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

#results:not(.grid-view) .tree > div:nth-child(2) {
  order: 2 !important; 
  flex: 1; 
  text-align: left;
}

#results:not(.grid-view) .tree > div:nth-child(1) {
  order: 3 !important; 
  width: 160px;
  flex: 0 0 160px;
}

#results:not(.grid-view) img {
  width: 100%;
  height: auto;
  max-height: 200px;
  display: block;
  border-radius: 4px;
  object-fit: contain;
}

    .score { font-weight: 800; color: #178A29; margin-bottom: 4px; font-size: 0.9rem; }
    .latin { font-style: italic; color: #555; margin-bottom: 8px; display: block; }
    .meta { font-size: 0.9rem; color: #444; line-height: 1.5; }
    .meta strong { color: #333; }

    .plan-selector .qty-controls {
      display: none;
      flex-direction: column;
      align-items: flex-start;
      gap: 5px;
    }

    .plan-selector:has(.plan-include:checked) .qty-controls {
      display: flex;
    }

    #results.grid-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
    }

    #results.grid-view .tree {
      flex-direction: column;
      align-items: center;
      text-align: center;
      border: 1px solid var(--secondary-accent, #BDBDBD) !important;
      padding: 10px;
      cursor: pointer;
      gap: 0.5rem;
    }

    #results.grid-view .tree img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      margin-bottom: 8px;
    }

    #results.grid-view .meta { display: none; }
    #results.grid-view .tree.expanded .meta { 
      display: block; 
      text-align: left; 
      margin-top: 10px;
      width: 100%;
    }

    .view-controls { margin-bottom: 1rem; display: flex; gap: 10px; }
    .view-btn {
      background-color: #eee;
      color: #333;
      border: 1px solid #ccc;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 4px;
    }

    .view-controls .view-btn.active {
      background-color: #558B2F !important;
      color: white !important;
      border-color: #3d522d;
    }

.help-icon.has-image:hover::after {
  content: ""; 
  position: absolute;
  top: 160%;           
  left: 50%;
  transform: translateX(-50%);
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  background-color: #fff; 
  border: 2px solid #555;
  border-radius: 10px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.35);
  z-index: 9999;
}

.help-icon.has-image:hover::before {
  content: "";
  position: absolute;
  top: 130%;           
  left: 50%;
  transform: translateX(-50%);
  border: 10px solid transparent;
  border-bottom-color: #555; 
  visibility: visible;
  opacity: 1;
  z-index: 10000;
}

.meta u {
  text-decoration-color: #2d6a4f;
  text-decoration-thickness: 2px;
  text-underline-offset: 3px;
  color: #1b4332;
  font-weight: 500;
}

.help-icon.soil-texture:hover::after {
  background-image: url('Images/soiltexture.jpg');
  width: 550px;
  height: 380px;
  left: 0; 
  transform: translateX(-15%);
}

.help-icon.soil-texture:hover::before {
  left: -3px; 
  transform: none;
}

.help-icon.soil-moisture:hover::after {
  background-image: url('Images/soilmoisture.jpg');
  width: 550px;
  height: 220px;
}

@media (max-width: 600px) {
  .help-icon.soil-texture:hover::after {
    width: 85vw;
    height: auto;
    aspect-ratio: 550 / 380;
    left: -20px; 
    transform: none;
  }

  .help-icon.soil-moisture:hover::after {
    width: 85vw;
    height: auto;
    aspect-ratio: 550 / 220;
    left: -20px;
    transform: none;
  }

  .help-icon.has-image:hover::before {
    display: none;
  }
}

.match-group {
  grid-column: 1 / -1 !important;
  width: 100%;
}

.match-group {
  border: none !important;
  padding: 0 !important;
}

.match-group summary {
  margin: 0 0 20px 0 !important; 
}

.match-group:first-of-type summary {
  margin-top: 10 !important;
}

#results.grid-view .group-content {
  display: grid !important;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)) !important;
  gap: 20px !important;
  width: 100% !important;
}

#results:not(.grid-view) .group-content {
  display: block !important;
}

#results:not(.grid-view) .tree {
  border-bottom: 2px solid var(--secondary-accent, #BDBDBD) !important;
}

summary::-webkit-details-marker {
  margin: 0 0 20px 0 !important; 
}

    @media print {
      body { background-color: white !important; padding: 0; }
      .container { box-shadow: none; border: none; width: 100%; max-width: 100%; }
      .filters, button, .help-icon, #clearBtn, .view-controls { display: none !important; }
      .tree { border-bottom: 1px solid #ccc; page-break-inside: avoid; }
    }

    #clearBtn, #planBtn { width: 100%; grid-column: 1 / -1; margin-top: -10px; }

.update-footer {
  margin-top: 20px;
  padding: 0px 0;
  text-align: center;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: #666;
  font-size: 0.85rem;
}

.update-footer time {
  font-weight: bold;
  color: #333;
}

.update-footer p::before {
  content: "üìÜ ";
  font-size: 1rem;
}

.star-toggle {
  cursor: pointer;
  color: #ccc;
  font-size: 1.2rem;
  margin-right: 8px;
  transition: color 0.2s, transform 0.2s;
  display: inline-block;
  vertical-align: middle;
}

.star-toggle.active {
  color: #FFD700;
  transform: scale(1.2);
}

.multiselect label, .filter-item label {
  display: flex;
  align-items: center;
}

.legend-star, .star-toggle.active {
  color: #FFD700;
  
  -webkit-text-stroke: 1px #333; 
  
  paint-order: stroke fill;
  
  font-size: 1.3rem;
  line-height: 1;
  display: inline-block;
  vertical-align: middle;
}
  
.leaf-particle {
  position: fixed;
  pointer-events: none;
  z-index: 10000;
  animation: windSweep linear forwards, wobble ease-in-out infinite;
  filter: drop-shadow(0 0 2px rgba(0,0,0,0.1)); 
  transition: filter 0.3s ease;
}

body.winter-active .leaf-particle {
  color: #ffffff !important;
  filter: grayscale(100%) brightness(10) !important;
}

body.spring-active .leaf-particle {
  color: #FF69B4 !important;
  filter: grayscale(100%) sepia(1) saturate(15) hue-rotate(295deg) brightness(1.0) !important;
}

@keyframes windSweep {
  0% { transform: translate(-10vw, 0) rotate(0deg); opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { transform: translate(120vw, 30vh) rotate(720deg); opacity: 0; }
}

@keyframes wobble {
  0%, 100% { margin-top: 0px; }
  50% { margin-top: -30px; }
}

body, .container, button, .view-btn {
  transition: background-color 0.8s cubic-bezier(0.4, 0, 0.2, 1), 
              border-color 0.8s ease !important;
}

input[type="checkbox"]:checked {
  accent-color: var(--accent-color);
}

button[onclick^="runFilter"] {
  background-color: var(--accent-color) !important;
}

#planBtn {
  background-color: var(--secondary-accent) !important;
}
  </style>
</head>

<body>
<button id="theme-toggle" onclick="toggleSeason()" 
  style="position: fixed; top: 15px; right: 15px; background: rgba(255,255,255,0.5); border: 1px solid #ccc; border-radius: 50%; width: 55px; height: 55px; font-size: 2rem; cursor: pointer; z-index: 9999; display: flex; align-items: center; justify-content: center; line-height: 0; padding: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.15);">
  üçÇ
</button>

<div class="container">
<h1>Funded Tree and Shrub Environmental Preference Selector</h1>
<p>Select multiple site conditions to filter species.</p>

<div class="project-info" style="margin-bottom: 2rem; padding: 1rem; background: #fdfaf7; border-radius: 8px; border: 1px solid #ccc;">
  <label for="projectTitle" style="font-size: 1.1rem;">Project Name:</label>
  <input type="text" id="projectTitle" placeholder="e.g. RPXXXX LastName Planting Assortment" 
       style="width: 100%; box-sizing: border-box; padding: 10px; font-size: 1rem; border-radius: 4px; border: 1px solid #ccc;">
</div>

<p style="font-size: 0.85rem; color: #555; margin: -10px 0 20px 0; display: flex; align-items: center; gap: 8px;">
  <span class="legend-star">‚òÖ</span> 
  <span>Toggle the star to <strong>require</strong> a match for that category (excludes all partial matches)</span>
</p>

<div class="filters">
  <!-- Soil Texture -->
  <div class="multiselect">
    <label>
	<span class="star-toggle" data-filter="soilTexture" onclick="toggleMandatory(this)">‚òÖ</span>
	Soil Texture      
	<span class="help-icon has-image soil-texture" data-tooltip="Loading resource...">?</span>
  </label>
    <div class="selectBox" onclick="toggleDropdown('textureChecks')">
      <select><option>Select Soil Texture(s)</option></select>
      <div class="overSelect"></div>
    </div>
    <div id="textureChecks" class="checkboxes">
      <label><input type="checkbox" name="soilTexture" value="Organic">Organic</label>
      <label><input type="checkbox" name="soilTexture" value="Clay">Clay</label>
      <label><input type="checkbox" name="soilTexture" value="Fine Loam">Fine Loam</label>
      <label><input type="checkbox" name="soilTexture" value="Coarse Loam">Coarse Loam</label>
      <label><input type="checkbox" name="soilTexture" value="Sand">Sand</label>
      <label><input type="checkbox" name="soilTexture" value="Rock">Rock</label>
      <label><input type="checkbox" name="soilTexture" value="Bedrock">Bedrock</label>
    </div>
  </div>

  <!-- Soil Moisture -->
  <div class="multiselect">
    <label>
	<span class="star-toggle" data-filter="soilMoisture" onclick="toggleMandatory(this)">‚òÖ</span>
	Soil Moisture  
	<span class="help-icon has-image soil-moisture" data-tooltip="Loading resource...">?</span>
  </label>
    <div class="selectBox" onclick="toggleDropdown('moistureChecks')">
      <select><option>Select Soil Moisture(s)</option></select>
      <div class="overSelect"></div>
    </div>
    <div id="moistureChecks" class="checkboxes">
      <label><input type="checkbox" name="soilMoisture" value="Dry">Dry</label>
      <label><input type="checkbox" name="soilMoisture" value="Fresh">Fresh</label>
      <label><input type="checkbox" name="soilMoisture" value="Moist">Moist</label>
      <label><input type="checkbox" name="soilMoisture" value="Wet">Wet</label>
    </div>
  </div>

  <!-- CoW -->
  <div class="multiselect">
    <label>
	<span class="star-toggle" data-filter="CoW" onclick="toggleMandatory(this)">‚òÖ</span>
	Coefficient of Wetness  
	<span class="help-icon" data-tooltip="Lowland Species = -5 to -3&#10;Variable Species (found in either environment) = -2 to 2&#10;Upland Species = 3 to 5">?</span>
</label>
    <div class="selectBox" onclick="toggleDropdown('cowChecks')">
      <select><option>Select CoW Class(es)</option></select>
      <div class="overSelect"></div>
    </div>
    <div id="cowChecks" class="checkboxes">
      <label><input type="checkbox" name="CoW" value="Lowland">Lowland (-5 to -3)</label>
      <label><input type="checkbox" name="CoW" value="Variable">Variable (-2 to 2)</label>
      <label><input type="checkbox" name="CoW" value="Upland">Upland (2 to 5)</label>
    </div>
  </div>

  <!-- Sunlight -->
  <div class="multiselect">
    <label>
	<span class="star-toggle" data-filter="sunlight" onclick="toggleMandatory(this)">‚òÖ</span>
	Sunlight  
	<span class="help-icon" data-tooltip="Full Sun = more than 6 hours of direct sun per day&#10;Part Shade = 4 to 6 hours of direct sun per day&#10;Shade = less than 4 hours of direct sun per day">?</span>
</label>
    <div class="selectBox" onclick="toggleDropdown('sunlightChecks')">
      <select><option>Select Sunlight Level(s)</option></select>
      <div class="overSelect"></div>
    </div>
    <div id="sunlightChecks" class="checkboxes">
      <label><input type="checkbox" name="sunlight" value="Full Sun">Full Sun ‚òÄÔ∏è</label>
      <label><input type="checkbox" name="sunlight" value="Part Shade">Part Shade üå§Ô∏è</label>
      <label><input type="checkbox" name="sunlight" value="Shade">Shade ‚òÅÔ∏è</label>
    </div>
  </div>

  <!-- Carbonate Presence -->
<div class="filter-item">
  <label for="carbonate">
  <span class="star-toggle" data-filter="carbonate" onclick="toggleMandatory(this)">‚òÖ</span>
  Carbonate Presence  
  <span class="help-icon" data-tooltip="Select the relative carbonate presense based on the reactivity of the ''fizz test''">?</span>
</label>
  <select id="carbonate" onchange="updateClearButton()">
    <option value="" disabled selected>Select Carbonate Presence</option>
    <option value="None">None</option>
    <option value="Low">Low</option>
    <option value="Medium">Medium</option>
    <option value="High">High</option>
  </select>
</div>

  <!-- Vendor -->
  <div class="multiselect">
    <label>Vendor  <span class="help-icon" data-tooltip="Select one or more vendors to include in your results. Species from unselected vendors will NOT appear in search results as partial matches.">?</span>
</label>
    <div class="selectBox" onclick="toggleDropdown('vendorChecks')">
      <select><option>Select Vendor(s)</option></select>
      <div class="overSelect"></div>
    </div>
    <div id="vendorChecks" class="checkboxes">
      <label><input type="checkbox" name="vendor" value="Hortico">Hortico</label>
      <label><input type="checkbox" name="vendor" value="Verbinnens">Verbinnen's Nursery</label>
    </div>
  </div>

  <button onclick="runFilter()">
  Find matching species
</button>
  <button id="clearBtn" onclick="clearAllFilters()" style="display: none; background-color: #666;">
  Clear All Filters
</button>
<button id="planBtn" onclick="exportPlantingPlan()" style="display: none; background-color: #33691E;">
  Export Selection as Planting Plan
</button>

</div>

<div class="view-controls">
  <button class="view-btn active" onclick="setView('list', this)">List View</button>
  <button class="view-btn" onclick="setView('grid', this)">Grid View</button>
</div>

<h2 id="resultsHeader" style="display: none; justify-content: space-between; align-items: center;">
  Results 
  <span id="resultCount" style="font-size: 1rem; font-weight: normal; color: #666;"></span>
</h2>
<div id="results"></div>

<script>

/* ============================================================
   SEASON STYLE TOGGLE
   ============================================================ */
let fadeInterval;
const windSound = new Audio("Audio/wind.mp3"); 
windSound.volume = 0.075;

let currentSeasonIndex = 0;
const seasons = [
  { name: 'summer', icon: 'üçÇ', bg: '#9CCC65', container: '#FDEBD0', primary: '#558B2F', secondary: '#33691E', particles: ['üçÉ', 'üåø', 'üå∏'] },
  { name: 'fall', icon: '‚ùÑÔ∏è', bg: '#944022', container: '#F2D4AE', primary: '#C25C30', secondary: '#963F1A', particles: ['üçÇ', 'üçÅ', 'üçÇ'] },
  { name: 'winter', icon: 'üå∏', bg: '#2C3E50', container: '#ECF0F1', primary: '#2980B9', secondary: '#1F618D', particles: ['‚ùÑÔ∏è', '‚ùÖ', '‚ú∂', '‚Çä', '‚äπ'] },
  { name: 'spring', icon: 'üçÉ', bg: '#F7C3E2', container: '#D3F2B3', primary: '#DE6FB1', secondary: '#B84489', particles: ['üå∏', 'ìá¢', '‡øî', 'üçÇ', 'ìÑº', 'ìÑπ'] }
];

function toggleSeason() {
  clearInterval(fadeInterval);
  if (windSound) {
    windSound.pause();
    windSound.currentTime = 0;
    windSound.volume = 0.075;
    windSound.play().catch(e => console.log("Audio blocked"));  
    setTimeout(() => fadeAudio(windSound), 5000); 
  }

  currentSeasonIndex = (currentSeasonIndex + 1) % seasons.length;
  const s = seasons[currentSeasonIndex];
  const body = document.body;

  body.style.setProperty('--accent-color', s.primary);
  body.style.setProperty('--secondary-accent', s.secondary);
  body.style.setProperty('--bg-color', s.bg);
  body.style.setProperty('--container-color', s.container);

  body.classList.remove('summer-active', 'fall-active', 'winter-active', 'spring-active');
  body.classList.add(`${s.name}-active`);

  const btn = document.getElementById('theme-toggle');
  if (btn) btn.innerHTML = s.icon;
  
  const container = document.querySelector('.container');
  if (container) container.style.backgroundColor = 'var(--container-color)';
  body.style.backgroundColor = 'var(--bg-color)';

  document.querySelectorAll('.view-btn').forEach(b => {
    if (b.classList.contains('active')) {
      b.style.setProperty('background-color', 'var(--accent-color)', 'important');
      b.style.setProperty('border-color', 'var(--secondary-accent)', 'important');
      b.style.color = '#ffffff';
    } else {
      b.style.setProperty('background-color', '#eee', 'important');
      b.style.setProperty('border-color', '#ccc', 'important');
      b.style.color = '#333';
    }
  });

  createWindGust(s.particles);

  localStorage.setItem('savedSeasonIndex', currentSeasonIndex);
}

function createWindGust(particles) {
  for (let i = 0; i < 45; i++) {
    setTimeout(() => {
      const leaf = document.createElement('div');
      leaf.className = 'leaf-particle';
      leaf.innerHTML = particles[Math.floor(Math.random() * particles.length)];
      leaf.style.left = "-10vw"; 
      leaf.style.top = (Math.random() * 110 - 20) + "vh"; 
      const duration = (Math.random() * 2 + 3); 
      leaf.style.animationDuration = `${duration}s, ${Math.random() * 0.5 + 2}s`; 
      leaf.style.opacity = "1";
      leaf.style.fontSize = (Math.random() * 1.2 + 1) + "rem";
      document.body.appendChild(leaf);
      setTimeout(() => leaf.remove(), 8000);
    }, i * 45); 
  }
}

function fadeAudio(audio) {
  if (!audio || audio.paused) return;
  fadeInterval = setInterval(() => {
    if (audio.volume > 0.007) {
      audio.volume -= 0.007;
    } else {
      audio.volume = 0;
      audio.pause();
      clearInterval(fadeInterval);
    }
  }, 200); 
}

/* ============================================================
   DROPDOWN CONTROLS
   ============================================================ */
   
function toggleDropdown(id) {
  const checkboxes = document.getElementById(id);
  const isVisible = checkboxes.style.display === "block";
  document.querySelectorAll('.checkboxes').forEach(el => el.style.display = 'none');
  checkboxes.style.display = isVisible ? "none" : "block";
}

window.onclick = function(event) {
  if (!event.target.closest('.multiselect')) {
    document.querySelectorAll('.checkboxes').forEach(el => el.style.display = 'none');
  }
};

/* ============================================================
   TREE DATA
   ============================================================ */

const trees = [
  {
    species: "Abies balsamea",
    commonName: "Balsam Fir",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Moist"],
    CoW: ["Lowland", "(-3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Medium"],
	vendor: ["Hortico"],
    image: "Images/abies_balsamea.jpg"
  },
  {
    species: "Acer nigrum",
    commonName: "Black Maple",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Part Shade", "Shade"],
    carbonate: ["Medium"],
	vendor: ["Hortico"],
    image: "Images/acer_nigrum.jpg"
  },
  {
    species: "Acer rubrum",
    commonName: "Red Maple",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist", "Wet"],
    CoW: ["Variable", "(0)"],
    sunlight: ["Full Sun", "Part Shade"],
    carbonate: ["High"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/acer_rubrum.jpg"
  },
  {
    species: "Acer saccharinum",
    commonName: "Silver Maple",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Fresh", "Moist", "Wet"],
    CoW: ["Lowland", "(-3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Medium"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/acer_saccharinum.jpg"
  },
  {
    species: "Acer saccharum",
    commonName: "Sugar Maple",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Part Shade", "Shade"],
    carbonate: ["Medium"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/acer_saccharum.jpg"
  },
  {
    species: "Acer x freemanii",
    commonName: "Freeman's Maple",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock"],
    soilMoisture: ["Dry", "Fresh", "Moist", "Wet"],
    CoW: ["Variable", "(-2)"],
    sunlight: ["Full Sun", "Part Shade"],
    carbonate: ["Medium", "High"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/acer_freemanii.jpg"
  },
  {
    species: "Amelanchier arborea",
    commonName: "Downy Serviceberry",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["None"],
	vendor: ["Hortico"],
    image: "Images/amelanchier_arborea.jpg"
  },
  {
    species: "Amelanchier laevis",
    commonName: "Smooth Serviceberry",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(5)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Medium"],
	vendor: ["Hortico"],
    image: "Images/amelanchier_laevis.jpg"
  },
  {
    species: "Betula alleghaniensis",
    commonName: "Yellow Birch",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Variable", "(0)"],
    sunlight: ["Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/betula_alleghaniensis.jpg"
  },
  {
    species: "Betula lenta",
    commonName: "Cherry Birch",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Verbinnens"],
    image: "Images/betula_lenta.jpg"
  },
  {
    species: "Betula papyrifera",
    commonName: "Paper Birch",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Moist"],
    CoW: ["Variable", "(2)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/betula_papyrifera.jpg"
  },
  {
    species: "Carpinus caroliniana",
    commonName: "Blue-beech",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Moist"],
    CoW: ["Variable", "(0)"],
    sunlight: ["Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico"],
    image: "Images/carpinus_caroliniana.jpg"
  },
  {
    species: "Carya cordiformis",
    commonName: "Bitternut Hickory",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Moist"],
    CoW: ["Variable", "(0)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["High"],
	vendor: ["Hortico"],
    image: "Images/carya_cordiformis.jpg"
  },
  {
    species: "Carya ovata",
    commonName: "Shagbark Hickory",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Medium"],
	vendor: ["Hortico"],
    image: "Images/carya_ovata.jpg"
  },
  {
    species: "Celtis occidentalis",
    commonName: "Hackberry",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Variable", "(1)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["High"],
	vendor: ["Hortico"],
    image: "Images/celtis_occidentalis.jpg"
  },
  {
    species: "Cercis canadensis",
    commonName: "Eastern Redbud",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Fresh", "Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/cercis_canadensis.jpg"
  },
  {
    species: "Cornus alternifolia",
    commonName: "Alternateleaf Dogwood",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Moist"],
    CoW: ["Upland", "(5)"],
    sunlight: ["Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/cornus_alternifolia.jpg"
  },
  {
    species: "Crataegus crus-galli",
    commonName: "Cockspur Hawthorn",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Variable", "(0)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["High"],
	vendor: ["Hortico"],
    image: "Images/crataegus_crus-galli.jpg"
  },
  {
    species: "Crataegus mollis",
    commonName: "Downy Hawthorn",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Variable", "(-2)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["High"],
	vendor: ["Hortico"],
    image: "Images/crataegus_mollis.jpg"
  },
  {
    species: "Crataegus punctata",
    commonName: "Dotted Hawthorn",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(5)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["High"],
	vendor: ["Verbinnens"],
    image: "Images/crataegus_punctata.jpg"
  },
  {
    species: "Fagus grandifolia",
    commonName: "American Beech",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico"],
    image: "Images/fagus_grandifolia.jpg"
  },
  {
    species: "Gleditsia triacanthos",
    commonName: "Honeylocust",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Fresh", "Moist"],
    CoW: ["Variable", "(0)"],
    sunlight: ["Full Sun", "Part Shade"],
    carbonate: ["Medium"],
	vendor: ["Verbinnens"],
    image: "Images/gleditsia_triacanthos.jpg"
  },
  {
    species: "Gymnocladus dioicus",
    commonName: "Kentucky Coffeetree",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(5)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Low", "Medium"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/gymnocladus_dioicus.jpg"
  },
  {
    species: "Hamamelis virginiana",
    commonName: "American Witch-hazel",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico"],
    image: "Images/hamamelis_virginiana.jpg"
  },
  {
    species: "Ilex verticillata",
    commonName: "Winterberry",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Fresh", "Moist", "Wet"],
    CoW: ["Lowland", "(-4)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/ilex_verticillata.jpg"
  },
  {
    species: "Juglans cinerea",
    commonName: "Butternut",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Moist"],
    CoW: ["Variable", "(2)"],
    sunlight: ["Full Sun"],
    carbonate: ["None"],
	vendor: ["Hortico"],
    image: "Images/juglans_cinerea.jpg"
  },
  {
    species: "Juglans nigra",
    commonName: "Black Walnut",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Full Sun", "Part Shade"],
    carbonate: ["High"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/juglans_nigra.jpg"
  },
  {
    species: "Juniperus virginiana",
    commonName: "Eastern Red Cedar",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["High"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/juniperus_virginiana.jpg"
  },
  {
    species: "Larix laricina",
    commonName: "Tamarack",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Lowland", "(-3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/larix_laricina.jpg"
  },
  {
    species: "Liriodendron tulipifera",
    commonName: "Tulip Tree",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Moist"],
    CoW: ["Variable", "(2)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico"],
    image: "Images/liriodendron_tulipifera.jpg"
  },
  {
    species: "Nyssa sylvatica",
    commonName: "Black Gum",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Lowland", "(-4)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["None"],
	vendor: ["Verbinnens"],
    image: "Images/nyssa_sylvatica.jpg"
  },
  {
    species: "Ostrya virginiana",
    commonName: "Ironwood",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(4)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Medium"],
	vendor: ["Verbinnens"],
    image: "Images/ostrya_virginiana.jpg"
  },
  {
    species: "Picea glauca",
    commonName: "White Spruce",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/picea_glauca.jpg"
  },
  {
    species: "Pinus strobus",
    commonName: "White Pine",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["None"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/pinus_strobus.jpg"
  },
  {
    species: "Platanus occidentalis",
    commonName: "Sycamore",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Moist"],
    CoW: ["Lowland", "(-3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["None"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/platanus_occidentalis.jpg"
  },
  {
    species: "Populus balsamifera",
    commonName: "Balsam Poplar",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Moist"],
    CoW: ["Lowland", "(-3)"],
    sunlight: ["Full Sun"],
    carbonate: ["High"],
	vendor: ["Hortico"],
    image: "Images/populus_balsamifera.jpg"
  },
  {
    species: "Populus deltoides",
    commonName: "Eastern Cottonwood",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Dry", "Fresh", "Moist", "Wet"],
    CoW: ["Variable", "(-1)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Medium"],
	vendor: ["Hortico"],
    image: "Images/populus_deltoides.jpg"
  },
  {
    species: "Populus grandidentata",
    commonName: "Largetooth Aspen",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Fresh", "Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Full Sun"],
    carbonate: ["Medium"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/populus_grandidentata.jpg"
  },
  {
    species: "Populus tremuloides",
    commonName: "Trembling Aspen",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist", "Wet"],
    CoW: ["Variable", "(0)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["High"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/populus_tremuloides.jpg"
  },
  {
    species: "Prunus pensylvanica",
    commonName: "Pin Cherry",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(4)"],
    sunlight: ["Full Sun"],
    carbonate: ["None"],
	vendor: ["Verbinnens"],
    image: "Images/prunus_pensylvanica.jpg"
  },
  {
    species: "Prunus serotina",
    commonName: "Black Cherry",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Medium", "High"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/prunus_serotina.jpg"
  },
  {
    species: "Prunus virginiana",
    commonName: "Chokecherry",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Variable", "(1)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["High"],
	vendor: ["Hortico"],
    image: "Images/prunus_virginiana.jpg"
  },
  {
    species: "Quercus alba",
    commonName: "White Oak",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Medium"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/quercus_alba.jpg"
  },
  {
    species: "Quercus bicolor",
    commonName: "Swamp White Oak",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Lowland", "(-4)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico"],
    image: "Images/quercus_bicolor.jpg"
  },
  {
    species: "Quercus macrocarpa",
    commonName: "Bur Oak",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Dry", "Fresh", "Moist", "Wet"],
    CoW: ["Variable", "(1)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Medium"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/quercus_macrocarpa.jpg"
  },
  {
    species: "Quercus palustris",
    commonName: "Pin Oak",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Lowland", "(-3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/quercus_palustris.jpg"
  },
  {
    species: "Quercus rubra",
    commonName: "Red Oak",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Full Sun", "Part Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/quercus_rubra.jpg"
  },
  {
    species: "Rhus typhina",
    commonName: "Staghorn Sumac",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry"],
    CoW: ["Upland", "(5)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["High"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/rhus_typhina.jpg"
  },
  {
    species: "Salix amygdaloides",
    commonName: "Peachleaf Willow",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Lowland", "(-3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Medium"],
	vendor: ["Hortico"],
    image: "Images/salix_amygdaloides.jpg"
  },
  {
    species: "Salix bebbiana",
    commonName: "Bebb's Willow",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Lowland", "(-4)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Unknown"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/salix_bebbiana.jpg"
  },
  {
    species: "Salix discolor",
    commonName: "Pussy Willow",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Lowland", "(-3)"],
    sunlight: ["Full Sun"],
    carbonate: ["Medium"],
	vendor: ["Hortico"],
    image: "Images/salix_discolor.jpg"
  },
  {
    species: "Salix eriocephala",
    commonName: "Heart-leaved Willow",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Lowland", "(-3)"],
    sunlight: ["Full Sun"],
    carbonate: ["Medium"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/salix_eriocephala.jpg"
  },
  {
    species: "Salix exigua",
    commonName: "Narrowleaf Willow",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Lowland", "(-5)"],
    sunlight: ["Full Sun", "Part Shade"],
    carbonate: ["High"],
	vendor: ["Hortico"],
    image: "Images/salix_exigua.jpg"
  },
  {
    species: "Salix lucida",
    commonName: "Shining Willow",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Lowland", "(-4)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Medium"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/salix_lucida.jpg"
  },
  {
    species: "Salix nigra",
    commonName: "Black Willow",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Lowland", "(-5)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/salix_nigra.jpg"
  },
  {
    species: "Salix petiolaris",
    commonName: "Meadow Willow",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock"],
    soilMoisture: ["Moist", "Wet"],
    CoW: ["Lowland", "(-4)"],
    sunlight: ["Full Sun"],
    carbonate: ["Unknown"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/salix_petiolaris.jpg"
  },
  {
    species: "Thuja occidentalis",
    commonName: "Eastern White Cedar",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Lowland", "(-3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["High"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/thuja_occidentalis.jpg"
  },
  {
    species: "Tilia americana",
    commonName: "Basswood",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Dry", "Fresh", "Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico"],
    image: "Images/tilia_americana.jpg"
  },
  {
    species: "Tsuga canadensis",
    commonName: "Eastern Hemlock",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Moist"],
    CoW: ["Upland", "(3)"],
    sunlight: ["Part Shade", "Shade"],
    carbonate: ["None"],
	vendor: ["Hortico"],
    image: "Images/tsuga_canadensis.jpg"
  },
  {
    species: "Ulmus americana",
    commonName: "American Elm",
    soilTexture: ["Clay", "Fine Loam", "Coarse Loam", "Sand", "Rock", "Bedrock"],
    soilMoisture: ["Moist"],
    CoW: ["Variable", "(-2)"],
    sunlight: ["Full Sun", "Part Shade"],
    carbonate: ["Medium"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/ulmus_americana.jpg"
  },
  {
    species: "Viburnum lentago",
    commonName: "Nannyberry",
    soilTexture: ["Organic", "Clay", "Fine Loam", "Coarse Loam", "Sand"],
    soilMoisture: ["Moist"],
    CoW: ["Variable", "(-1)"],
    sunlight: ["Full Sun", "Part Shade", "Shade"],
    carbonate: ["Low"],
	vendor: ["Hortico", "Verbinnens"],
    image: "Images/viburnum_lentago.jpg"
  }
];

/* ============================================================
   FILTERING LOGIC
   ============================================================ */
let mandatoryFilters = [];

function toggleMandatory(el) {
  const filterName = el.getAttribute("data-filter");
  el.classList.toggle("active");

  if (el.classList.contains("active")) {
    if (!mandatoryFilters.includes(filterName)) {
      mandatoryFilters.push(filterName);
    }
  } else {
    mandatoryFilters = mandatoryFilters.filter(item => item !== filterName);
  }
}
   
function runFilter() {
  const getChecked = (name) => 
    Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);

  const filters = {
    soilTexture: getChecked("soilTexture"),
    soilMoisture: getChecked("soilMoisture"),
    CoW: getChecked("CoW"),
    sunlight: getChecked("sunlight"),
    carbonate: document.getElementById("carbonate").value,
    vendor: getChecked("vendor"),
  };

  const carbRank = { "None": 0, "Low": 1, "Medium": 2, "High": 3, "Unknown": 0 };

  const filteredTrees = trees.filter(tree => {
    if (filters.vendor.length > 0) {
      if (!filters.vendor.some(val => tree.vendor.includes(val))) return false;
    }

    for (let key of mandatoryFilters) {
      const userSelection = filters[key];
      if (!userSelection || userSelection.length === 0) continue; 

      if (key === "carbonate") {
        const treeRanks = Array.isArray(tree.carbonate) ? tree.carbonate.map(val => carbRank[val] || 0) : [carbRank[tree.carbonate] || 0];
        if (Math.max(...treeRanks) < carbRank[userSelection]) return false;
      } else {
        if (!userSelection.some(val => tree[key].includes(val))) return false;
      }
    }
    return true; 
  });

  const scored = filteredTrees.map(tree => {
    let score = 0;
    let maxScore = 0;

    Object.keys(filters).forEach(key => {
      if (key === "vendor" || mandatoryFilters.includes(key)) return;

      const userSelection = filters[key];
      if (key === "carbonate") {
        if (userSelection !== "") {
          maxScore++;
          const treeRanks = Array.isArray(tree.carbonate) ? tree.carbonate.map(val => carbRank[val] || 0) : [carbRank[tree.carbonate] || 0];
          if (Math.max(...treeRanks) >= carbRank[userSelection]) score++;
        }
      } else {
        if (userSelection.length > 0) {
          maxScore++;
          if (userSelection.some(val => tree[key].includes(val))) score++;
        }
      }
    });

    return { tree, score, maxScore, ratio: maxScore > 0 ? score / maxScore : 1 };
  });

  const results = scored.filter(r => r.score > 0 || r.maxScore === 0).sort((a, b) => b.ratio - a.ratio);
  renderResults(results);
  document.getElementById('clearBtn').style.display = "block";
}

/* ============================================================
   RENDERING
   ============================================================ */

function highlightMatches(treeTraits, category) {
  const checked = (category === "carbonate") 
    ? [document.getElementById("carbonate").value] 
    : Array.from(document.querySelectorAll(`input[name="${category}"]:checked`)).map(cb => cb.value);
  
  const carbRank = { "None": 0, "Low": 1, "Medium": 2, "High": 3, "Unknown": 0 };
  const siteRank = carbRank[document.getElementById("carbonate").value] || 0;
  
  let formattedResult = "";

  treeTraits.forEach((trait, index) => {
    let isMatch = false;
    if (category === "carbonate") {
      isMatch = siteRank > 0 && carbRank[trait] >= siteRank;
    } else {
      isMatch = checked.includes(trait);
    }
    
    const traitHtml = isMatch 
      ? `<u style="text-decoration-thickness: 2px; text-underline-offset: 3px; text-decoration-color: #2d6a4f;">${trait}</u>` 
      : trait;

    if (index > 0) {
      if (trait.startsWith("(")) {
        formattedResult += " "; 
      } else {
        formattedResult += ", "; 
      }
    }
    formattedResult += traitHtml;
  });

  return formattedResult;
}

function renderResults(results, isClearing = false) {
  const container = document.getElementById("results");
  const pdfBtn = document.getElementById("pdfBtn");
  const planBtn = document.getElementById("planBtn");
  const resultsHeader = document.getElementById("resultsHeader");
  const clearBtn = document.getElementById("clearBtn");
  const isGridView = container.classList.contains("grid-view"); 

  container.innerHTML = ""; 

  if (isClearing || results.length === 0) {
    if (pdfBtn) pdfBtn.style.display = "none";
    if (planBtn) planBtn.style.display = "none";
    if (resultsHeader) resultsHeader.style.display = "none";
    if (isClearing && clearBtn) clearBtn.style.display = "none";
    if (results.length === 0 && !isClearing) container.innerHTML = "<p>No suitable species found. Try unstarring some categories and searching again.</p>";
    return;
  }

  resultsHeader.style.display = "flex";
  if (pdfBtn) pdfBtn.style.display = "block";
  if (planBtn) planBtn.style.display = "block";
  document.getElementById("resultCount").textContent = `${results.length} species found`;

  const isMiss = (category, treeTraits) => {
    if (category === "vendor" || mandatoryFilters.includes(category)) return false;
    const checked = (category === "carbonate") 
      ? document.getElementById("carbonate").value 
      : Array.from(document.querySelectorAll(`input[name="${category}"]:checked`)).map(cb => cb.value);
    if (!checked || checked.length === 0 || checked === "") return false;
    if (category === "carbonate") {
      const carbRank = { "None": 0, "Low": 1, "Medium": 2, "High": 3, "Unknown": 0 };
      const siteRank = carbRank[checked] || 0;
      const treeRanks = Array.isArray(treeTraits) ? treeTraits.map(v => carbRank[v] || 0) : [carbRank[treeTraits] || 0];
      return Math.max(...treeRanks) < siteRank;
    }
    return !checked.some(val => treeTraits.includes(val));
  };

  const labelStyle = (cat, traits) => isMiss(cat, traits) 
    ? `style="color: #ae2012; font-weight: bold; text-decoration: underline; text-decoration-color: #ae2012; text-underline-offset: 3px;"` 
    : `style="font-weight: bold;"`;

  const groups = results.reduce((acc, item) => {
    const percent = Math.round(item.ratio * 100);
    if (!acc[percent]) acc[percent] = [];
    acc[percent].push(item);
    return acc;
  }, {});

  const sortedPercents = Object.keys(groups).sort((a, b) => b - a);

  sortedPercents.forEach((percent, index) => {
    const hue = percent * 1.2; 
    const matchColor = `hsl(${hue}, 70%, 25%)`;

    const details = document.createElement("details");
    details.open = true;
    details.className = "match-group";
    details.style.gridColumn = "1 / -1"; 

    const summary = document.createElement("summary");
    summary.style = `list-style: none; cursor: pointer; padding: 15px 0; border-bottom: 2px solid ${matchColor}; color: ${matchColor}; font-size: 1.4rem; font-weight: 800; display: flex; justify-content: space-between; align-items: center;`;
    summary.innerHTML = `<span>${percent}% Match</span><span style="font-size: 0.9rem; font-weight: normal; color: #666;">${groups[percent].length} species found &nbsp; ‚ñæ</span>`;
    details.appendChild(summary);

    const listContainer = document.createElement("div");
    listContainer.className = "group-content";

    groups[percent].forEach(({ tree, ratio }) => {
      const div = document.createElement("div");
      div.className = "tree";
      div.onclick = function(e) { 
        if (!e.target.closest('.plan-selector')) this.classList.toggle('expanded'); 
      };

      const scoreStyle = `color: ${matchColor}; font-weight: 800;`;

      div.innerHTML = `
        <div>${tree.image ? `<img src="${tree.image}" alt="${tree.commonName}">` : ""}</div>
        <div style="flex-grow: 1;">
          <div class="score" style="${scoreStyle}">Match: ${percent}%</div>
          <div><strong>${tree.commonName}</strong></div>
          <div class="latin" style="font-size: 0.85rem; color: #666; font-style: italic;">${tree.species}</div>
          <div class="meta">
            <hr style="border: 0; border-top: 1.5px solid #E4D5C5;">
            <span ${labelStyle("soilTexture", tree.soilTexture)}>Soil Texture:</span> ${highlightMatches(tree.soilTexture, "soilTexture")}<br>
            <span ${labelStyle("soilMoisture", tree.soilMoisture)}>Soil Moisture:</span> ${highlightMatches(tree.soilMoisture, "soilMoisture")}<br>
            <span ${labelStyle("CoW", tree.CoW)}>CoW:</span> ${highlightMatches(tree.CoW, "CoW")}<br>
            <span ${labelStyle("sunlight", tree.sunlight)}>Sunlight:</span> ${highlightMatches(tree.sunlight, "sunlight")}<br>
            <span ${labelStyle("carbonate", tree.carbonate)}>Carbonate:</span> ${highlightMatches(tree.carbonate, "carbonate")}<br>
			      <span ${labelStyle("vendor", tree.vendor)}>Vendor:</span> ${highlightMatches(tree.vendor, "vendor")}
          </div>
        </div>
        <div class="plan-selector" style="display: flex; flex-direction: column; align-items: flex-start; justify-content: center; min-width: 110px; gap: 8px; padding-top: 10px;">
          <label style="font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: bold;">
            <input type="checkbox" class="plan-include" style="margin: 0;"> Add to Plan
          </label>
          <div class="qty-controls">
            <label style="font-size: 0.75rem; margin: 0;">Quantity:</label>
            <input type="number" class="plan-qty" value="1" min="1" style="width: 50px; text-align: center; border: 1px solid #ccc; border-radius: 4px;">
          </div>
        </div>`;
      
      listContainer.appendChild(div);
    });

    details.appendChild(listContainer);
    container.appendChild(details);
  });
}
/* ============================================================
   UTILITIES & EXPORTS
   ============================================================ */

function updateCounter(categoryName, selectBoxId) {
  const checkedCount = document.querySelectorAll(`input[name="${categoryName}"]:checked`).length;
  const selectBox = document.getElementById(selectBoxId);
  if (!selectBox) return;
  const selectElement = selectBox.parentElement.querySelector('select option');
  const defaults = { 
    textureChecks: "Select Soil Texture(s)", 
    moistureChecks: "Select Soil Moisture(s)", 
    cowChecks: "Select CoW Class(es)", 
    sunlightChecks: "Select Sunlight Level(s)", 
    vendorChecks: "Select Vendor(s)" 
  };
  selectElement.textContent = checkedCount > 0 ? `${checkedCount} Selected` : (defaults[selectBoxId] || "Select Options");
}

document.addEventListener('change', (e) => {
  if (e.target.type === 'checkbox' && e.target.name) {
    const parentDropdown = e.target.closest('.checkboxes');
    if (parentDropdown) updateCounter(e.target.name, parentDropdown.id);
  }
});

function clearAllFilters() {
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);  
  
  const carb = document.getElementById("carbonate");
  if (carb) { carb.value = ""; carb.selectedIndex = 0; }

  if (typeof mandatoryFilters !== 'undefined') {
    mandatoryFilters = [];
    document.querySelectorAll('.star-toggle').forEach(star => star.classList.remove('active'));
  }

  ["textureChecks", "moistureChecks", "cowChecks", "sunlightChecks", "vendorChecks"].forEach(id => {
    const nameMap = { 
      textureChecks: "soilTexture", 
      moistureChecks: "soilMoisture", 
      cowChecks: "CoW", 
      sunlightChecks: "sunlight", 
      vendorChecks: "vendor" 
    };
    updateCounter(nameMap[id], id);
  });

  renderResults([], true); 
}

function setView(viewType, btn) {
  const container = document.getElementById("results");
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  container.className = (viewType === 'grid') ? 'grid-view' : '';

  const s = seasons[currentSeasonIndex];
  document.querySelectorAll('.view-btn.active').forEach(b => {
    b.style.setProperty('background-color', s.primary, 'important');
    b.style.setProperty('color', '#ffffff', 'important');
    b.style.setProperty('border-color', s.secondary, 'important');
  });
  document.querySelectorAll('.view-btn:not(.active)').forEach(b => {
    b.style.setProperty('background-color', '#eee', 'important');
    b.style.setProperty('color', '#333', 'important');
    b.style.setProperty('border-color', '#ccc', 'important');
  });
}

function exportPlantingPlan() {
  const projectTitle = document.getElementById("projectTitle").value || "Planting Plan";
  const selectedTrees = [];

  document.querySelectorAll(".tree").forEach(treeDiv => {
    if (treeDiv.querySelector(".plan-include").checked) {
      const common = treeDiv.querySelector("strong").textContent;
      const latin = treeDiv.querySelector(".latin").textContent;
      const qty = treeDiv.querySelector(".plan-qty").value;
      selectedTrees.push({ common, latin, qty });
    }
  });

  if (selectedTrees.length === 0) {
    alert("Please select species first.");
    return;
  }

  const totalQty = selectedTrees.reduce((sum, t) => sum + parseInt(t.qty || 0), 0);
  const printWindow = window.open('', '_blank');
  
  let tableHtml = `
    <html>
    <head>
      <title>${projectTitle}</title>
    </head>
    <body style="font-family: sans-serif; color: #1a2f23; padding: 20px;">
      <h1 style="color: #384B2A; margin-bottom: 20px;">${projectTitle}</h1>
      
      <table id="plan-table" style="width: max-content; min-width: 400px; border-collapse: collapse; border: 1px solid #C2D5B4;">
        <thead>
          <tr style="background-color: #275317; color: #ffffff;">
            <th style="padding: 12px 10px; text-align: left; border: 0px solid #C2D5B4;">Common Name</th>
            <th style="padding: 12px 10px; text-align: left; border: 0px solid #C2D5B4;">Scientific Name</th>
            <th style="padding: 12px 10px; text-align: right; border: 0px solid #C2D5B4;">Quantity</th>
          </tr>
        </thead>
        <tbody>
          ${selectedTrees.map((t, i) => `
            <tr style="background-color: ${i % 2 === 0 ? '#ffffff' : '#daf2d0'};">
              <td style="padding: 10px; border: 0px solid #e9ecef;">${t.common}</td>
              <td style="padding: 10px; border: 0px solid #e9ecef; font-style: italic;">${t.latin}</td>
              <td style="padding: 10px; border: 0px solid #e9ecef; text-align: right;">${t.qty}</td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr style="background-color: #275317; color: #ffffff; font-weight: bold;">
            <td colspan="2" style="padding: 12px 10px; border: 0px solid #C2D5B4;">Total Trees & Shrubs:</td>
            <td style="padding: 12px 10px; text-align: right; border: 0px solid #C2D5B4;">${totalQty}</td>
          </tr>
        </tfoot>
      </table>

      <button onclick="copyTableOnly()" style="margin-top: 20px; padding: 10px 20px; cursor: pointer; background: #275317; color: white; border: none; border-radius: 4px; font-weight: bold;">
        Copy Table for Excel/Word
      </button>

      <script>
        function copyTableOnly() {
          const table = document.getElementById("plan-table");
          if (!table) return;

          const listener = (e) => {
            e.clipboardData.setData("text/html", table.outerHTML);
            e.clipboardData.setData("text/plain", table.innerText);
            e.preventDefault();
          };

          document.addEventListener("copy", listener);
          const successful = document.execCommand("copy");
          document.removeEventListener("copy", listener);

          if (successful) {
            alert("Table copied! You can now paste directly into Excel or Word.");
          } else {
            alert("Copy failed. Try selecting the table manually.");
          }
        }
      <\/script>
    </body>
    </html>`;

  printWindow.document.write(tableHtml);
  printWindow.document.close();
}
</script>

<footer class="update-footer">
  <p>Last Updated: <time id="last-updated"></time></p>
</footer>

<a href="#top" id="back-to-top">Back to Top ‚Üë</a>

<script>
  const date = new Date(document.lastModified);
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  document.getElementById("last-updated").innerHTML = date.toLocaleDateString('en-CA', options);
  
  window.addEventListener('DOMContentLoaded', () => {
    const savedIndex = localStorage.getItem('treeSelector_savedSeason');
    
    if (savedIndex !== null) {
      currentSeasonIndex = parseInt(savedIndex);
      const s = seasons[currentSeasonIndex];
      const body = document.body;

      body.style.setProperty('--accent-color', s.primary);
      body.style.setProperty('--secondary-accent', s.secondary);
      body.style.setProperty('--body-bg', s.bg);
      body.style.setProperty('--container-bg', s.container);

      body.classList.remove('summer-active', 'fall-active', 'winter-active', 'spring-active');
      body.classList.add(`${s.name}-active`);

      const btn = document.getElementById('theme-toggle');
      if (btn) btn.innerHTML = s.icon;
      
      const container = document.querySelector('.container');
      if (container) container.style.backgroundColor = 'var(--container-bg)';
      body.style.backgroundColor = 'var(--body-bg)';

      const title = document.getElementById("projectTitleDisplay") || document.querySelector("h1");
      if (title) title.style.setProperty('color', s.primary, 'important');
      
      const backToTop = document.getElementById('back-to-top');
      if (backToTop) backToTop.style.setProperty('background-color', s.primary, 'important');
    }
  });
</script>
</body>
</html>
